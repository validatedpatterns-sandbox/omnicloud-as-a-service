---
# This task creates/updates an OpenShift/Kubernetes API Bearer Token credential in AAP
# 
# Configuration variables:
#   openshift_dynamic_retrieval: Enable dynamic retrieval (default: true)
#   openshift_token_user: Specific user/service account to get token for (default: current user)
#   openshift_token_namespace: Namespace for service account token (default: default)
#   openshift_verify_ssl: Verify SSL certificates (default: false)
#
# Dynamic retrieval methods (in order):
#   1. oc whoami --show-server and oc whoami -t (current user)
#   2. kubectl config view (from kubeconfig)
#   3. KUBERNETES_SERVICE_HOST (in-cluster)
#   4. Service account token from /var/run/secrets/kubernetes.io/serviceaccount/token
#   5. kubeadmin password from common install locations
#   6. kubeconfig file parsing
#   7. ~/.omnicloud-aap.txt config file (fallback)
#
# For kubeadmin specifically, set: openshift_token_user=kubeadmin

- name: Initialize dynamic retrieval variables
  ansible.builtin.set_fact:
    openshift_api_endpoint: ""
    openshift_bearer_token: ""
    openshift_verify_ssl: false

- name: Try to get kubeadmin password from common locations (priority)
  ansible.builtin.slurp:
    src: "{{ item }}"
  register: kubeadmin_password_result
  changed_when: false
  failed_when: false
  no_log: true
  loop:
    - /root/install/auth/kubeadmin-password
    - /root/auth/kubeadmin-password
    - /install/auth/kubeadmin-password
    - /auth/kubeadmin-password
  when: openshift_dynamic_retrieval | default(true)

- name: Get kubeadmin password from file
  ansible.builtin.set_fact:
    kubeadmin_password: "{{ item.content | b64decode | trim }}"
  loop: "{{ kubeadmin_password_result.results | default([]) }}"
  when:
    - openshift_dynamic_retrieval | default(true)
    - kubeadmin_password is not defined or kubeadmin_password == ""
    - item is defined
    - item.failed is defined
    - item.failed == false
    - item.content is defined
  loop_control:
    label: "{{ item.item }}"

- name: Login as kubeadmin to get API endpoint and token
  ansible.builtin.shell: |
    if [ -n "{{ kubeadmin_password | default('') }}" ]; then
      oc login -u kubeadmin -p "{{ kubeadmin_password }}" --insecure-skip-tls-verify=true 2>&1 >/dev/null
      if [ $? -eq 0 ]; then
        echo "SERVER=$(oc whoami --show-server)"
        echo "TOKEN=$(oc whoami -t)"
      fi
    fi
  register: oc_kubeadmin_login_result
  changed_when: false
  failed_when: false
  no_log: true
  when:
    - openshift_dynamic_retrieval | default(true)
    - kubeadmin_password is defined and kubeadmin_password != ""

- name: Extract API endpoint from kubeadmin login (oc whoami --show-server)
  ansible.builtin.set_fact:
    openshift_api_endpoint: "{{ oc_kubeadmin_login_result.stdout_lines | select('match', '^SERVER=.*') | first | regex_replace('^SERVER=', '') | trim }}"
  when:
    - openshift_dynamic_retrieval | default(true)
    - oc_kubeadmin_login_result.rc == 0
    - oc_kubeadmin_login_result.stdout is defined
    - "'SERVER=' in oc_kubeadmin_login_result.stdout"

- name: Extract bearer token from kubeadmin login (oc whoami -t)
  ansible.builtin.set_fact:
    openshift_bearer_token: "{{ oc_kubeadmin_login_result.stdout_lines | select('match', '^TOKEN=.*') | first | regex_replace('^TOKEN=', '') | trim }}"
  when:
    - openshift_dynamic_retrieval | default(true)
    - oc_kubeadmin_login_result.rc == 0
    - oc_kubeadmin_login_result.stdout is defined
    - "'TOKEN=' in oc_kubeadmin_login_result.stdout"

- name: Get API endpoint from oc whoami --show-server (fallback if not logged in as kubeadmin)
  ansible.builtin.shell: oc whoami --show-server
  register: oc_server_result
  changed_when: false
  failed_when: false
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_api_endpoint == ""

- name: Set API endpoint from oc whoami --show-server (fallback)
  ansible.builtin.set_fact:
    openshift_api_endpoint: "{{ oc_server_result.stdout | trim }}"
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_api_endpoint == ""
    - oc_server_result.rc == 0
    - oc_server_result.stdout is defined
    - oc_server_result.stdout | trim != ""

- name: Try to get API endpoint from kubectl command (fallback)
  ansible.builtin.shell: kubectl config view --minify -o jsonpath='{.clusters[0].cluster.server}'
  register: kubectl_server_result
  changed_when: false
  failed_when: false
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_api_endpoint == ""

- name: Set API endpoint from kubectl command (fallback)
  ansible.builtin.set_fact:
    openshift_api_endpoint: "{{ kubectl_server_result.stdout | trim }}"
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_api_endpoint == ""
    - kubectl_server_result.rc == 0
    - kubectl_server_result.stdout | trim != ""

- name: Get KUBERNETES_SERVICE_HOST (in-cluster fallback)
  ansible.builtin.shell: echo "${KUBERNETES_SERVICE_HOST:-}"
  register: kubernetes_service_host
  changed_when: false
  failed_when: false
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_api_endpoint == ""

- name: Get KUBERNETES_SERVICE_PORT_HTTPS (in-cluster fallback)
  ansible.builtin.shell: echo "${KUBERNETES_SERVICE_PORT_HTTPS:-443}"
  register: kubernetes_service_port
  changed_when: false
  failed_when: false
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_api_endpoint == ""
    - kubernetes_service_host.stdout | trim != ""

- name: Set API endpoint from KUBERNETES_SERVICE_HOST (in-cluster fallback)
  ansible.builtin.set_fact:
    openshift_api_endpoint: "https://{{ kubernetes_service_host.stdout | trim }}:{{ kubernetes_service_port.stdout | trim }}"
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_api_endpoint == ""
    - kubernetes_service_host.stdout | trim != ""


- name: Get bearer token from oc whoami -t (after kubeadmin login or current user)
  ansible.builtin.shell: oc whoami -t
  register: oc_token_result
  changed_when: false
  failed_when: false
  no_log: true
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_bearer_token == ""

- name: Set bearer token from oc whoami -t
  ansible.builtin.set_fact:
    openshift_bearer_token: "{{ oc_token_result.stdout | trim }}"
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_bearer_token == ""
    - oc_token_result.rc == 0
    - oc_token_result.stdout is defined
    - oc_token_result.stdout | trim != ""

- name: Try to get bearer token for specific service account
  ansible.builtin.shell: oc sa get-token {{ openshift_token_user }} -n {{ openshift_token_namespace | default('default') }}
  register: oc_sa_token_result
  changed_when: false
  failed_when: false
  no_log: true
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_bearer_token == ""
    - openshift_token_user | default('') != ""
    - openshift_token_user | default('') != "kubeadmin"

- name: Set bearer token for specific service account
  ansible.builtin.set_fact:
    openshift_bearer_token: "{{ oc_sa_token_result.stdout | trim }}"
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_bearer_token == ""
    - openshift_token_user | default('') != ""
    - openshift_token_user | default('') != "kubeadmin"
    - oc_sa_token_result.rc == 0
    - oc_sa_token_result.stdout | trim != ""


- name: Check if service account token exists (in-cluster)
  ansible.builtin.stat:
    path: /var/run/secrets/kubernetes.io/serviceaccount/token
  register: sa_token_file
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_bearer_token == ""

- name: Try to get bearer token from service account (in-cluster)
  ansible.builtin.slurp:
    src: /var/run/secrets/kubernetes.io/serviceaccount/token
  register: sa_token_result
  changed_when: false
  failed_when: false
  no_log: true
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_bearer_token == ""
    - sa_token_file.stat.exists | default(false)

- name: Set bearer token from service account
  ansible.builtin.set_fact:
    openshift_bearer_token: "{{ sa_token_result.content | b64decode }}"
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_bearer_token == ""
    - sa_token_file.stat.exists | default(false)
    - sa_token_result.failed == false


- name: Try to get API endpoint from kubeconfig file
  ansible.builtin.shell: |
    kubeconfig="${KUBECONFIG:-${HOME}/.kube/config}"
    if [ -f "$kubeconfig" ]; then
      grep -A 5 "server:" "$kubeconfig" | grep "server:" | head -1 | awk '{print $2}'
    fi
  register: kubeconfig_server_result
  changed_when: false
  failed_when: false
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_api_endpoint == ""

- name: Set API endpoint from kubeconfig
  ansible.builtin.set_fact:
    openshift_api_endpoint: "{{ kubeconfig_server_result.stdout | trim }}"
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_api_endpoint == ""
    - kubeconfig_server_result.rc == 0
    - kubeconfig_server_result.stdout | trim != ""

- name: Try to get bearer token from kubeconfig file
  ansible.builtin.shell: |
    kubeconfig="${KUBECONFIG:-${HOME}/.kube/config}"
    if [ -f "$kubeconfig" ]; then
      grep -A 2 "token:" "$kubeconfig" | grep "token:" | head -1 | awk '{print $2}'
    fi
  register: kubeconfig_token_result
  changed_when: false
  failed_when: false
  no_log: true
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_bearer_token == ""

- name: Set bearer token from kubeconfig
  ansible.builtin.set_fact:
    openshift_bearer_token: "{{ kubeconfig_token_result.stdout | trim }}"
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_bearer_token == ""
    - kubeconfig_token_result.rc == 0
    - kubeconfig_token_result.stdout | trim != ""

- name: Get HOME directory
  ansible.builtin.shell: echo "${HOME:-/root}"
  register: home_dir
  changed_when: false
  failed_when: false
  when: openshift_api_endpoint == "" or openshift_bearer_token == ""

- name: Read omnicloud-aap config file (fallback)
  ansible.builtin.slurp:
    src: "{{ home_dir.stdout | trim }}/.omnicloud-aap.txt"
  register: omnicloud_config_raw
  failed_when: false
  changed_when: false
  when: openshift_api_endpoint == "" or openshift_bearer_token == ""

- name: Parse config file lines
  ansible.builtin.set_fact:
    config_lines: "{{ omnicloud_config_raw.content | b64decode | split('\n') | select('match', '^[^#].*=.*') | list }}"
  when:
    - omnicloud_config_raw is defined
    - omnicloud_config_raw.content is defined
    - (omnicloud_config_raw.failed | default(true)) == false
    - openshift_api_endpoint == "" or openshift_bearer_token == ""

- name: Extract API endpoint from config
  ansible.builtin.set_fact:
    openshift_api_endpoint: "{{ item.split('=')[1] | trim }}"
  loop: "{{ config_lines | default([]) | select('match', '.*api.*endpoint.*|.*endpoint.*') | list }}"
  when: 
    - config_lines is defined
    - openshift_api_endpoint == ""
    - item.split('=') | length == 2
  loop_control:
    label: "{{ item[:50] }}"

- name: Extract bearer token from config
  ansible.builtin.set_fact:
    openshift_bearer_token: "{{ item.split('=')[1] | trim }}"
  loop: "{{ config_lines | default([]) | select('match', '.*bearer.*token.*|.*token.*') | list }}"
  when: 
    - config_lines is defined
    - openshift_bearer_token == ""
    - item.split('=') | length == 2
  loop_control:
    label: "{{ item[:50] }}"

- name: Extract verify_ssl from config (optional)
  ansible.builtin.set_fact:
    openshift_verify_ssl_config: "{{ item.split('=')[1] | trim | lower }}"
  loop: "{{ config_lines | default([]) | select('match', '.*verify.*ssl.*') | list }}"
  when: 
    - config_lines is defined
    - item.split('=') | length == 2
  loop_control:
    label: "{{ item[:50] }}"

- name: Set verify_ssl from config or default
  ansible.builtin.set_fact:
    openshift_verify_ssl: "{{ (openshift_verify_ssl_config | default('false') | lower) == 'true' }}"
  when:
    - openshift_verify_ssl_config is defined

- name: Set default verify_ssl if not set
  ansible.builtin.set_fact:
    openshift_verify_ssl: false
  when: openshift_verify_ssl is not defined

- name: Fail if API endpoint is missing or not from oc whoami --show-server
  ansible.builtin.fail:
    msg: "Missing API endpoint from 'oc whoami --show-server'. This is required for ocaas-cluster-creds. Current endpoint: {{ openshift_api_endpoint | default('not set') }}. Please ensure 'oc' is available and kubeadmin login succeeded."
  when: 
    - openshift_api_endpoint == ""
    - (oc_kubeadmin_login_result is not defined or oc_kubeadmin_login_result.rc != 0) and (oc_server_result is not defined or oc_server_result.rc != 0)

- name: Fail if bearer token is missing or not from oc whoami -t
  ansible.builtin.fail:
    msg: "Missing bearer token from 'oc whoami -t'. This is required for ocaas-cluster-creds. Please ensure 'oc' is available and kubeadmin login succeeded. Token status: {{ oc_token_result.rc | default('task was skipped') }}"
  when: 
    - openshift_bearer_token == ""
    - (oc_kubeadmin_login_result is not defined or oc_kubeadmin_login_result.rc != 0) and (oc_token_result is not defined or oc_token_result.rc != 0)

- name: Get all credentials
  ansible.builtin.uri:
    url: "https://{{ aap_hostname }}/api/controller/v2/credentials/"
    method: GET
    user: "{{ aap_username }}"
    password: "{{ aap_password }}"
    validate_certs: "{{ aap_validate_certs }}"
    force_basic_auth: true
  register: all_credentials

- name: Check if credential exists
  ansible.builtin.set_fact:
    existing_credential: "{{ all_credentials.json.results | default([]) | selectattr('name', 'equalto', 'ocaas-cluster-creds') | list | first | default({}) }}"

- name: Get credential types
  ansible.builtin.uri:
    url: "https://{{ aap_hostname }}/api/controller/v2/credential_types/"
    method: GET
    user: "{{ aap_username }}"
    password: "{{ aap_password }}"
    validate_certs: "{{ aap_validate_certs }}"
    force_basic_auth: true
  register: credential_types

- name: Find OpenShift/Kubernetes API Bearer Token credential type
  ansible.builtin.set_fact:
    openshift_credential_type_id: "{{ item.id }}"
  loop: "{{ credential_types.json.results | default([]) }}"
  when:
    - openshift_credential_type_id is not defined or openshift_credential_type_id == None
    - ("openshift" in (item.name | lower) or "kubernetes" in (item.name | lower))
    - ("bearer" in (item.name | lower) or "token" in (item.name | lower) or "api" in (item.name | lower))
  loop_control:
    label: "{{ item.name }}"

- name: Fail if credential type not found
  ansible.builtin.fail:
    msg: "Could not find OpenShift/Kubernetes API Bearer Token credential type. Available types: {{ credential_types.json.results | default([]) | map(attribute='name') | list }}"
  when: openshift_credential_type_id is not defined or openshift_credential_type_id == None

- name: Get organization ID (default organization)
  ansible.builtin.uri:
    url: "https://{{ aap_hostname }}/api/controller/v2/organizations/"
    method: GET
    user: "{{ aap_username }}"
    password: "{{ aap_password }}"
    validate_certs: "{{ aap_validate_certs }}"
    force_basic_auth: true
  register: organizations

- name: Set default organization ID
  ansible.builtin.set_fact:
    default_organization_id: "{{ organizations.json.results[0].id | default(1) }}"

- name: Create credential if it doesn't exist
  ansible.builtin.uri:
    url: "https://{{ aap_hostname }}/api/controller/v2/credentials/"
    method: POST
    user: "{{ aap_username }}"
    password: "{{ aap_password }}"
    validate_certs: "{{ aap_validate_certs }}"
    force_basic_auth: true
    body_format: json
    body:
      name: "ocaas-cluster-creds"
      description: "openshift cluster token"
      credential_type: "{{ openshift_credential_type_id }}"
      organization: "{{ default_organization_id }}"
      inputs:
        host: "{{ openshift_api_endpoint }}"
        bearer_token: "{{ openshift_bearer_token }}"
        verify_ssl: "{{ openshift_verify_ssl | default(false) }}"
    status_code: [200, 201]
  register: create_credential_result
  when: existing_credential is not defined or existing_credential == {}
  no_log: true

- name: Update credential if it exists
  ansible.builtin.uri:
    url: "https://{{ aap_hostname }}/api/controller/v2/credentials/{{ existing_credential.id }}/"
    method: PATCH
    user: "{{ aap_username }}"
    password: "{{ aap_password }}"
    validate_certs: "{{ aap_validate_certs }}"
    force_basic_auth: true
    body_format: json
    body:
      description: "openshift cluster token"
      inputs:
        host: "{{ openshift_api_endpoint }}"
        bearer_token: "{{ openshift_bearer_token }}"
        verify_ssl: "{{ openshift_verify_ssl | default(false) }}"
    status_code: [200, 201, 202, 204]
  register: update_credential_result
  when: existing_credential is defined and existing_credential != {}
  no_log: true

- name: Display credential creation/update result
  ansible.builtin.debug:
    msg: "Credential 'ocaas-cluster-creds' {{ 'created' if (existing_credential is not defined or existing_credential == {}) else 'updated' }} successfully (ID: {{ create_credential_result.json.id | default(update_credential_result.json.id | default(existing_credential.id)) }})"

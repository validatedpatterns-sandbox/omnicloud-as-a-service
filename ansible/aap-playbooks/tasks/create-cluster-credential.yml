---
# This task creates/updates an OpenShift/Kubernetes API Bearer Token credential in AAP
# 
# Configuration variables:
#   openshift_dynamic_retrieval: Enable dynamic retrieval (default: true)
#   openshift_token_user: Specific user/service account to get token for (default: current user)
#   openshift_token_namespace: Namespace for service account token (default: default)
#   openshift_verify_ssl: Verify SSL certificates (default: false)
#
# Dynamic retrieval methods (in order):
#   1. oc whoami --show-server and oc whoami -t (current user)
#   2. kubectl config view (from kubeconfig)
#   3. KUBERNETES_SERVICE_HOST (in-cluster)
#   4. Service account token from /var/run/secrets/kubernetes.io/serviceaccount/token
#   5. kubeadmin password from common install locations
#   6. kubeconfig file parsing
#   7. ~/.omnicloud-aap.txt config file (fallback)
#
# For kubeadmin specifically, set: openshift_token_user=kubeadmin

- name: Initialize dynamic retrieval variables
  ansible.builtin.set_fact:
    openshift_api_endpoint: ""
    openshift_bearer_token: ""
    openshift_verify_ssl: false

- name: Try to get API endpoint from oc command
  ansible.builtin.shell: oc whoami --show-server
  register: oc_server_result
  changed_when: false
  failed_when: false
  when: openshift_dynamic_retrieval | default(true)

- name: Set API endpoint from oc command
  ansible.builtin.set_fact:
    openshift_api_endpoint: "{{ oc_server_result.stdout | trim }}"
  when:
    - openshift_dynamic_retrieval | default(true)
    - oc_server_result.rc == 0
    - oc_server_result.stdout | trim != ""

- name: Try to get API endpoint from kubectl command
  ansible.builtin.shell: kubectl config view --minify -o jsonpath='{.clusters[0].cluster.server}'
  register: kubectl_server_result
  changed_when: false
  failed_when: false
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_api_endpoint == ""

- name: Set API endpoint from kubectl command
  ansible.builtin.set_fact:
    openshift_api_endpoint: "{{ kubectl_server_result.stdout | trim }}"
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_api_endpoint == ""
    - kubectl_server_result.rc == 0
    - kubectl_server_result.stdout | trim != ""

- name: Try to get API endpoint from KUBERNETES_SERVICE_HOST (in-cluster)
  ansible.builtin.set_fact:
    openshift_api_endpoint: "https://{{ ansible_env.KUBERNETES_SERVICE_HOST | default('') }}:{{ ansible_env.KUBERNETES_SERVICE_PORT_HTTPS | default('443') }}"
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_api_endpoint == ""
    - ansible_env.KUBERNETES_SERVICE_HOST is defined
    - ansible_env.KUBERNETES_SERVICE_HOST != ""

- name: Try to get bearer token from oc command (current user)
  ansible.builtin.shell: oc whoami -t
  register: oc_token_result
  changed_when: false
  failed_when: false
  no_log: true
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_token_user | default('') == ""

- name: Set bearer token from oc command (current user)
  ansible.builtin.set_fact:
    openshift_bearer_token: "{{ oc_token_result.stdout | trim }}"
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_token_user | default('') == ""
    - oc_token_result.rc == 0
    - oc_token_result.stdout | trim != ""

- name: Try to get bearer token for specific service account
  ansible.builtin.shell: oc sa get-token {{ openshift_token_user }} -n {{ openshift_token_namespace | default('default') }}
  register: oc_sa_token_result
  changed_when: false
  failed_when: false
  no_log: true
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_bearer_token == ""
    - openshift_token_user | default('') != ""
    - openshift_token_user | default('') != "kubeadmin"

- name: Set bearer token for specific service account
  ansible.builtin.set_fact:
    openshift_bearer_token: "{{ oc_sa_token_result.stdout | trim }}"
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_bearer_token == ""
    - openshift_token_user | default('') != ""
    - openshift_token_user | default('') != "kubeadmin"
    - oc_sa_token_result.rc == 0
    - oc_sa_token_result.stdout | trim != ""

- name: Try to get kubeadmin token using oc (if logged in as kubeadmin)
  ansible.builtin.shell: oc whoami -t
  register: oc_kubeadmin_token_result
  changed_when: false
  failed_when: false
  no_log: true
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_bearer_token == ""
    - openshift_token_user | default('') == "kubeadmin"

- name: Set kubeadmin token from oc
  ansible.builtin.set_fact:
    openshift_bearer_token: "{{ oc_kubeadmin_token_result.stdout | trim }}"
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_bearer_token == ""
    - openshift_token_user | default('') == "kubeadmin"
    - oc_kubeadmin_token_result.rc == 0
    - oc_kubeadmin_token_result.stdout | trim != ""

- name: Check if service account token exists (in-cluster)
  ansible.builtin.stat:
    path: /var/run/secrets/kubernetes.io/serviceaccount/token
  register: sa_token_file
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_bearer_token == ""

- name: Try to get bearer token from service account (in-cluster)
  ansible.builtin.slurp:
    src: /var/run/secrets/kubernetes.io/serviceaccount/token
  register: sa_token_result
  changed_when: false
  failed_when: false
  no_log: true
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_bearer_token == ""
    - sa_token_file.stat.exists | default(false)

- name: Set bearer token from service account
  ansible.builtin.set_fact:
    openshift_bearer_token: "{{ sa_token_result.content | b64decode }}"
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_bearer_token == ""
    - sa_token_file.stat.exists | default(false)
    - sa_token_result.failed == false

- name: Try to get kubeadmin token from common locations
  ansible.builtin.slurp:
    src: "{{ item }}"
  register: kubeadmin_token_result
  changed_when: false
  failed_when: false
  no_log: true
  loop:
    - /root/install/auth/kubeadmin-password
    - /root/auth/kubeadmin-password
    - /install/auth/kubeadmin-password
    - /auth/kubeadmin-password
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_bearer_token == ""
    - (openshift_token_user | default('') == "kubeadmin" or openshift_token_user | default('') == "")

- name: Set kubeadmin token if found
  ansible.builtin.set_fact:
    openshift_bearer_token: "{{ item.content | b64decode | trim }}"
  loop: "{{ kubeadmin_token_result.results | default([]) }}"
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_bearer_token == ""
    - item.failed == false
    - item.content is defined
  loop_control:
    label: "{{ item.item }}"

- name: Try to get API endpoint from kubeconfig file
  ansible.builtin.shell: |
    kubeconfig="{{ ansible_env.KUBECONFIG | default(ansible_env.HOME + '/.kube/config') }}"
    if [ -f "$kubeconfig" ]; then
      grep -A 5 "server:" "$kubeconfig" | grep "server:" | head -1 | awk '{print $2}'
    fi
  register: kubeconfig_server_result
  changed_when: false
  failed_when: false
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_api_endpoint == ""

- name: Set API endpoint from kubeconfig
  ansible.builtin.set_fact:
    openshift_api_endpoint: "{{ kubeconfig_server_result.stdout | trim }}"
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_api_endpoint == ""
    - kubeconfig_server_result.rc == 0
    - kubeconfig_server_result.stdout | trim != ""

- name: Try to get bearer token from kubeconfig file
  ansible.builtin.shell: |
    kubeconfig="{{ ansible_env.KUBECONFIG | default(ansible_env.HOME + '/.kube/config') }}"
    if [ -f "$kubeconfig" ]; then
      grep -A 2 "token:" "$kubeconfig" | grep "token:" | head -1 | awk '{print $2}'
    fi
  register: kubeconfig_token_result
  changed_when: false
  failed_when: false
  no_log: true
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_bearer_token == ""

- name: Set bearer token from kubeconfig
  ansible.builtin.set_fact:
    openshift_bearer_token: "{{ kubeconfig_token_result.stdout | trim }}"
  when:
    - openshift_dynamic_retrieval | default(true)
    - openshift_bearer_token == ""
    - kubeconfig_token_result.rc == 0
    - kubeconfig_token_result.stdout | trim != ""

- name: Read omnicloud-aap config file (fallback)
  ansible.builtin.slurp:
    src: "{{ ansible_env.HOME }}/.omnicloud-aap.txt"
  register: omnicloud_config_raw
  failed_when: false
  changed_when: false
  when: openshift_api_endpoint == "" or openshift_bearer_token == ""

- name: Parse config file lines
  ansible.builtin.set_fact:
    config_lines: "{{ omnicloud_config_raw.content | b64decode | split('\n') | select('match', '^[^#].*=.*') | list }}"
  when:
    - omnicloud_config_raw.failed == false
    - openshift_api_endpoint == "" or openshift_bearer_token == ""

- name: Extract API endpoint from config
  ansible.builtin.set_fact:
    openshift_api_endpoint: "{{ item.split('=')[1] | trim }}"
  loop: "{{ config_lines | default([]) | select('match', '.*api.*endpoint.*|.*endpoint.*') | list }}"
  when: 
    - omnicloud_config_raw.failed == false
    - openshift_api_endpoint == ""
    - item.split('=') | length == 2
  loop_control:
    label: "{{ item[:50] }}"

- name: Extract bearer token from config
  ansible.builtin.set_fact:
    openshift_bearer_token: "{{ item.split('=')[1] | trim }}"
  loop: "{{ config_lines | default([]) | select('match', '.*bearer.*token.*|.*token.*') | list }}"
  when: 
    - omnicloud_config_raw.failed == false
    - openshift_bearer_token == ""
    - item.split('=') | length == 2
  loop_control:
    label: "{{ item[:50] }}"

- name: Extract verify_ssl from config (optional)
  ansible.builtin.set_fact:
    openshift_verify_ssl_config: "{{ item.split('=')[1] | trim | lower }}"
  loop: "{{ config_lines | default([]) | select('match', '.*verify.*ssl.*') | list }}"
  when: 
    - omnicloud_config_raw.failed == false
    - item.split('=') | length == 2
  loop_control:
    label: "{{ item[:50] }}"

- name: Set verify_ssl from config or default
  ansible.builtin.set_fact:
    openshift_verify_ssl: "{{ (openshift_verify_ssl_config | default('false') | lower) == 'true' }}"
  when:
    - omnicloud_config_raw.failed == false
    - openshift_verify_ssl_config is defined

- name: Set default verify_ssl if not set
  ansible.builtin.set_fact:
    openshift_verify_ssl: false
  when: openshift_verify_ssl is not defined

- name: Fail if API endpoint or token is missing
  ansible.builtin.fail:
    msg: "Missing required values. Could not retrieve API endpoint and bearer token dynamically or from ~/.omnicloud-aap.txt. Set openshift_dynamic_retrieval=false to disable dynamic retrieval, or ensure config file exists with api_endpoint and bearer_token."
  when: 
    - openshift_api_endpoint == "" or openshift_bearer_token == ""

- name: Get all credentials
  ansible.builtin.uri:
    url: "https://{{ aap_hostname }}/api/controller/v2/credentials/"
    method: GET
    user: "{{ aap_username }}"
    password: "{{ aap_password }}"
    validate_certs: "{{ aap_validate_certs }}"
    force_basic_auth: true
  register: all_credentials

- name: Check if credential exists
  ansible.builtin.set_fact:
    existing_credential: "{{ all_credentials.json.results | default([]) | selectattr('name', 'equalto', 'ocaas-cluster-creds') | list | first | default({}) }}"

- name: Get credential types
  ansible.builtin.uri:
    url: "https://{{ aap_hostname }}/api/controller/v2/credential_types/"
    method: GET
    user: "{{ aap_username }}"
    password: "{{ aap_password }}"
    validate_certs: "{{ aap_validate_certs }}"
    force_basic_auth: true
  register: credential_types

- name: Find OpenShift/Kubernetes API Bearer Token credential type
  ansible.builtin.set_fact:
    openshift_credential_type_id: "{{ item.id }}"
  loop: "{{ credential_types.json.results | default([]) }}"
  when:
    - openshift_credential_type_id is not defined or openshift_credential_type_id == None
    - ("openshift" in (item.name | lower) or "kubernetes" in (item.name | lower))
    - ("bearer" in (item.name | lower) or "token" in (item.name | lower) or "api" in (item.name | lower))
  loop_control:
    label: "{{ item.name }}"

- name: Fail if credential type not found
  ansible.builtin.fail:
    msg: "Could not find OpenShift/Kubernetes API Bearer Token credential type. Available types: {{ credential_types.json.results | default([]) | map(attribute='name') | list }}"
  when: openshift_credential_type_id is not defined or openshift_credential_type_id == None

- name: Get organization ID (default organization)
  ansible.builtin.uri:
    url: "https://{{ aap_hostname }}/api/controller/v2/organizations/"
    method: GET
    user: "{{ aap_username }}"
    password: "{{ aap_password }}"
    validate_certs: "{{ aap_validate_certs }}"
    force_basic_auth: true
  register: organizations

- name: Set default organization ID
  ansible.builtin.set_fact:
    default_organization_id: "{{ organizations.json.results[0].id | default(1) }}"

- name: Create credential if it doesn't exist
  ansible.builtin.uri:
    url: "https://{{ aap_hostname }}/api/controller/v2/credentials/"
    method: POST
    user: "{{ aap_username }}"
    password: "{{ aap_password }}"
    validate_certs: "{{ aap_validate_certs }}"
    force_basic_auth: true
    body_format: json
    body:
      name: "ocaas-cluster-creds"
      description: "openshift cluster token"
      credential_type: "{{ openshift_credential_type_id }}"
      organization: "{{ default_organization_id }}"
      inputs:
        host: "{{ openshift_api_endpoint }}"
        bearer_token: "{{ openshift_bearer_token }}"
        verify_ssl: "{{ openshift_verify_ssl | default(false) }}"
    status_code: [200, 201]
  register: create_credential_result
  when: existing_credential is not defined or existing_credential == {}
  no_log: true

- name: Update credential if it exists
  ansible.builtin.uri:
    url: "https://{{ aap_hostname }}/api/controller/v2/credentials/{{ existing_credential.id }}/"
    method: PATCH
    user: "{{ aap_username }}"
    password: "{{ aap_password }}"
    validate_certs: "{{ aap_validate_certs }}"
    force_basic_auth: true
    body_format: json
    body:
      description: "openshift cluster token"
      inputs:
        host: "{{ openshift_api_endpoint }}"
        bearer_token: "{{ openshift_bearer_token }}"
        verify_ssl: "{{ openshift_verify_ssl | default(false) }}"
    status_code: [200, 201, 202, 204]
  register: update_credential_result
  when: existing_credential is defined and existing_credential != {}
  no_log: true

- name: Display credential creation/update result
  ansible.builtin.debug:
    msg: "Credential 'ocaas-cluster-creds' {{ 'created' if (existing_credential is not defined or existing_credential == {}) else 'updated' }} successfully (ID: {{ create_credential_result.json.id | default(update_credential_result.json.id | default(existing_credential.id)) }})"

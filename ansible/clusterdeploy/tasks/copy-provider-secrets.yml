---
# Copy provider credentials secrets from hive namespace to target namespace
# This allows reusing shared provider secrets across multiple clusters in different namespaces

- name: Check if target namespace exists
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Namespace
    name: "{{ cluster.name }}"
  register: target_namespace_check
  ignore_errors: true

- name: Create target namespace if it doesn't exist
  kubernetes.core.k8s:
    name: "{{ cluster.name }}"
    api_version: v1
    kind: Namespace
    state: present
  when: target_namespace_check.resources | length == 0

- name: "Check if AWS credentials secret exists in hive namespace"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: "aws-creds"
    namespace: "hive"
  register: aws_creds_hive
  ignore_errors: true
  when:
    - cloud.provider == 'Amazon'
    - not user_provided_credentials | default(false)

- name: "Copy AWS credentials secret from hive to {{ cluster.name }}"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "aws-creds"
        namespace: "{{ cluster.name }}"
      type: "{{ aws_creds_hive.resources[0].type }}"
      data: "{{ aws_creds_hive.resources[0].data }}"
  when:
    - cloud.provider == 'Amazon'
    - not user_provided_credentials | default(false)
    - aws_creds_hive.resources is defined
    - aws_creds_hive.resources | length > 0

- name: "Check if GCP credentials secret exists in hive namespace"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: "gcp-creds"
    namespace: "hive"
  register: gcp_creds_hive
  ignore_errors: true
  when:
    - cloud.provider == 'Google'
    - not user_provided_credentials | default(false)

- name: "Copy GCP credentials secret from hive to {{ cluster.name }}"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "gcp-creds"
        namespace: "{{ cluster.name }}"
      type: "{{ gcp_creds_hive.resources[0].type }}"
      data: "{{ gcp_creds_hive.resources[0].data }}"
  when:
    - cloud.provider == 'Google'
    - not user_provided_credentials | default(false)
    - gcp_creds_hive.resources is defined
    - gcp_creds_hive.resources | length > 0

- name: "Check if Azure credentials secret exists in hive namespace"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: "azure-creds"
    namespace: "hive"
  register: azure_creds_hive
  ignore_errors: true
  when:
    - cloud.provider == 'Azure'
    - not user_provided_credentials | default(false)

- name: "Copy Azure credentials secret from hive to {{ cluster.name }}"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "azure-creds"
        namespace: "{{ cluster.name }}"
      type: "{{ azure_creds_hive.resources[0].type }}"
      data: "{{ azure_creds_hive.resources[0].data }}"
  when:
    - cloud.provider == 'Azure'
    - not user_provided_credentials | default(false)
    - azure_creds_hive.resources is defined
    - azure_creds_hive.resources | length > 0

- name: "Check if global-pullsecret exists in hive namespace"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: "global-pullsecret"
    namespace: "hive"
  register: pullsecret_hive
  ignore_errors: true
  when: not user_provided_credentials | default(false)

- name: "Copy global-pullsecret from hive to {{ cluster.name }}"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "global-pullsecret"
        namespace: "{{ cluster.name }}"
      type: "{{ pullsecret_hive.resources[0].type }}"
      data: "{{ pullsecret_hive.resources[0].data }}"
  when:
    - not user_provided_credentials | default(false)
    - pullsecret_hive.resources is defined
    - pullsecret_hive.resources | length > 0

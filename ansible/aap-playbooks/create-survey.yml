---
- hosts: localhost
  gather_facts: no

  tasks:
    - name: Read helm values
      ansible.builtin.include_vars:
        file: "/pattern-home/helm-values/values.yaml"

    - name: Read vars file
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../vars.yml"

    - name: Set AAP connection variables
      no_log: true
      ansible.builtin.set_fact:
        aap_hostname: "{{ aap_hostname | default('aap-ansible-automation-platform.' + global.localClusterDomain) }}"
        aap_validate_certs: "{{ aap_validate_certs | default(false) }}"
        aap_username: "{{ aap_username | default('admin') }}"
        aap_password: "{{ aap_password | default(lookup('file', '/pattern-home/aap-admin-password/password') | default('admin')) }}"
        cloud_providers:
          - name: "Amazon"
            template_name: "OmniCloud - Amazon Template"
          - name: "Azure"
            template_name: "OmniCloud - Azure Template"
          - name: "Google"
            template_name: "OmniCloud - Google Template"

    - name: Wait for Automation Controller to be ready
      ansible.builtin.uri:
        url: "https://{{ aap_hostname }}/api/controller/v2/ping/"
        method: GET
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        validate_certs: "{{ aap_validate_certs }}"
        force_basic_auth: true
      register: ping_check
      until: ping_check.status == 200
      retries: 30
      delay: 10
      ignore_errors: true

    - name: Build survey spec from vars.yml
      ansible.builtin.set_fact:
        survey_questions:
          - question_name: "Cluster Name"
            question_description: "Name of the cluster to deploy"
            variable: "cluster_name_input"
            required: true
            type: "text"
            default: ""
          - question_name: "Cluster Group"
            question_description: "Cluster group for application deployment"
            variable: "cluster_clusterGroup_input"
            required: true
            type: "text"
            default: "devops"
          - question_name: "Base Domain"
            question_description: "Base domain for the cluster"
            variable: "cluster_baseDomain_input"
            required: true
            type: "text"
            default: ""
          - question_name: "Cloud Provider"
            question_description: "Cloud provider (aws, azure, gcp)"
            variable: "cloud_provider_input"
            required: true
            type: "multiplechoice"
            choices:
              - "Amazon"
              - "Azure"
              - "Google"
            default: ""
          - question_name: "Cloud Region"
            question_description: "Region for cloud deployment"
            variable: "cloud_region_input"
            required: true
            type: "text"
            default: ""
          - question_name: "Control Plane Replicas"
            question_description: "Number of control plane replicas"
            variable: "mp_controlPlane_replicas_input"
            required: true
            type: "integer"
            default: 3
          - question_name: "Control Plane Machine Type"
            question_description: "Machine type for control plane nodes"
            variable: "mp_controlPlane_machineType_input"
            required: true
            type: "text"
            default: ""
          - question_name: "Worker Replicas"
            question_description: "Number of worker replicas"
            variable: "mp_workers_replicas_input"
            required: true
            type: "integer"
            default: 3
          - question_name: "Worker Machine Type"
            question_description: "Machine type for worker nodes"
            variable: "mp_workers_machineType_input"
            required: true
            type: "text"
            default: ""
          - question_name: "Azure Resource Group"
            question_description: "Azure resource group name (required for Azure)"
            variable: "cc_azure_resourceGroup_input"
            required: false
            type: "text"
            default: ""
          - question_name: "GCP Project ID"
            question_description: "GCP project ID (required for GCP)"
            variable: "cc_gcp_projectID_input"
            required: false
            type: "text"
            default: ""

    - name: Build survey spec with description
      ansible.builtin.set_fact:
        survey_spec:
          name: "Cluster Deployment Survey"
          description: "Cluster deployment configuration survey"
          spec: "{{ survey_questions }}"

    - name: Get all inventories
      ansible.builtin.uri:
        url: "https://{{ aap_hostname }}/api/controller/v2/inventories/"
        method: GET
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        validate_certs: "{{ aap_validate_certs }}"
        force_basic_auth: true
      register: all_inventories

    - name: Get all projects
      ansible.builtin.uri:
        url: "https://{{ aap_hostname }}/api/controller/v2/projects/"
        method: GET
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        validate_certs: "{{ aap_validate_certs }}"
        force_basic_auth: true
      register: all_projects

    - name: Set default inventory and project IDs
      ansible.builtin.set_fact:
        default_inventory_id: "{{ all_inventories.json.results[0].id | default(1) }}"
        default_project_id: "{{ all_projects.json.results[0].id | default(6) }}"

    - name: Get all job templates
      ansible.builtin.uri:
        url: "https://{{ aap_hostname }}/api/controller/v2/job_templates/"
        method: GET
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        validate_certs: "{{ aap_validate_certs }}"
        force_basic_auth: true
      register: all_job_templates

    - name: Display available resources
      ansible.builtin.debug:
        msg: "Available inventories: {{ all_inventories.json.results | default([]) | map(attribute='name') | list }}, Available projects: {{ all_projects.json.results | default([]) | map(attribute='name') | list }}"

    - name: Create or update job templates for each cloud provider
      block:
        - name: Check if job template exists
          ansible.builtin.set_fact:
            existing_template: "{{ all_job_templates.json.results | default([]) | selectattr('name', 'equalto', item.template_name) | list | first }}"

        - name: Create job template if it doesn't exist
          ansible.builtin.uri:
            url: "https://{{ aap_hostname }}/api/controller/v2/job_templates/"
            method: POST
            user: "{{ aap_username }}"
            password: "{{ aap_password }}"
            validate_certs: "{{ aap_validate_certs }}"
            force_basic_auth: true
            body_format: json
            body:
              name: "{{ item.template_name }}"
              description: "Job template for {{ item.name }} cloud provider deployments"
              inventory: "{{ default_inventory_id }}"
              project: "{{ default_project_id }}"
              playbook: "{{ job_template_playbook | default('hello_world.yml') }}"
              job_type: "run"
          register: create_template_result
          when: existing_template is not defined or existing_template == {}
          ignore_errors: true

        - name: Refresh job templates list after creation
          ansible.builtin.uri:
            url: "https://{{ aap_hostname }}/api/controller/v2/job_templates/?name={{ item.template_name }}"
            method: GET
            user: "{{ aap_username }}"
            password: "{{ aap_password }}"
            validate_certs: "{{ aap_validate_certs }}"
            force_basic_auth: true
          register: refreshed_template
          when: existing_template is not defined or existing_template == {}

        - name: Get job template ID (use existing or newly created)
          ansible.builtin.set_fact:
            template_id: "{{ (existing_template.id if (existing_template is defined and existing_template != {}) else (refreshed_template.json.results[0].id if (refreshed_template is defined and refreshed_template.json.results | length > 0) else (create_template_result.json.id | default(None)))) | default(existing_template.id) }}"

        - name: Fail if template ID cannot be determined
          ansible.builtin.fail:
            msg: "Could not determine template ID for '{{ item.template_name }}'. Template may not exist and creation may have failed."
          when: template_id is not defined or template_id == None

        - name: Enable survey on job template
          ansible.builtin.uri:
            url: "https://{{ aap_hostname }}/api/controller/v2/job_templates/{{ template_id }}/"
            method: PATCH
            user: "{{ aap_username }}"
            password: "{{ aap_password }}"
            validate_certs: "{{ aap_validate_certs }}"
            force_basic_auth: true
            body_format: json
            body:
              survey_enabled: true
          register: enable_survey_result

        - name: Set survey spec on job template
          ansible.builtin.uri:
            url: "https://{{ aap_hostname }}/api/controller/v2/job_templates/{{ template_id }}/survey_spec/"
            method: POST
            user: "{{ aap_username }}"
            password: "{{ aap_password }}"
            validate_certs: "{{ aap_validate_certs }}"
            force_basic_auth: true
            body_format: json
            body: "{{ survey_spec }}"
          register: survey_result
          ignore_errors: true
          failed_when: false

        - name: Check if survey spec API call failed
          ansible.builtin.fail:
            msg: "Failed to set survey spec for '{{ item.template_name }}'. Status: {{ survey_result.status | default('unknown') }}, Response: {{ survey_result.json | default(survey_result.msg) | to_nice_json }}"
          when: survey_result.status is defined and survey_result.status not in [200, 201, 202, 204]

        - name: Verify survey was created
          ansible.builtin.uri:
            url: "https://{{ aap_hostname }}/api/controller/v2/job_templates/{{ template_id }}/"
            method: GET
            user: "{{ aap_username }}"
            password: "{{ aap_password }}"
            validate_certs: "{{ aap_validate_certs }}"
            force_basic_auth: true
          register: verify_template

        - name: Display survey creation result
          ansible.builtin.debug:
            msg: "Survey created/updated successfully for job template '{{ item.template_name }}' (ID: {{ template_id }}). Survey enabled: {{ verify_template.json.survey_enabled | default('not set') }}"
      loop: "{{ cloud_providers }}"
      loop_control:
        label: "{{ item.template_name }}"

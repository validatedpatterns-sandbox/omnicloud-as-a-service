---
# This task creates/updates an OpenShift/Kubernetes API Bearer Token credential in AAP
# 
# Configuration file: ~/.omniaap
# Expected format:
#   api_endpoint=https://api.example.com:6443
#   bearer_token=your-token-here
#   verify_ssl=false
#
# Configuration variables:
#   openshift_verify_ssl: Verify SSL certificates (default: false, can be overridden in config file)

- name: Get HOME directory
  ansible.builtin.shell: echo "${HOME:-/root}"
  register: home_dir
  changed_when: false
  failed_when: false

- name: Read ~/.omniaap config file
  ansible.builtin.slurp:
    src: "{{ home_dir.stdout | trim }}/.omniaap"
  register: omniaap_config_raw
  failed_when: false
  changed_when: false

- name: Parse config file lines
  ansible.builtin.set_fact:
    config_lines: "{{ omniaap_config_raw.content | b64decode | split('\n') | select('match', '^[^#].*=.*') | list }}"
  when:
    - omniaap_config_raw.failed == false
    - omniaap_config_raw.content is defined

- name: Extract API endpoint from ~/.omniaap
  ansible.builtin.set_fact:
    openshift_api_endpoint: "{{ item.split('=')[1] | trim }}"
  loop: "{{ config_lines | default([]) | select('match', '.*api.*endpoint.*|.*endpoint.*') | list }}"
  when: 
    - config_lines is defined
    - item.split('=') | length == 2
  loop_control:
    label: "{{ item[:50] }}"

- name: Extract bearer token from ~/.omniaap
  ansible.builtin.set_fact:
    openshift_bearer_token: "{{ item.split('=')[1] | trim }}"
  loop: "{{ config_lines | default([]) | select('match', '.*bearer.*token.*|.*token.*') | list }}"
  when: 
    - config_lines is defined
    - item.split('=') | length == 2
  loop_control:
    label: "{{ item[:50] }}"

- name: Extract verify_ssl from ~/.omniaap (optional)
  ansible.builtin.set_fact:
    openshift_verify_ssl_config: "{{ item.split('=')[1] | trim | lower }}"
  loop: "{{ config_lines | default([]) | select('match', '.*verify.*ssl.*') | list }}"
  when: 
    - config_lines is defined
    - item.split('=') | length == 2
  loop_control:
    label: "{{ item[:50] }}"

- name: Set verify_ssl from config or default
  ansible.builtin.set_fact:
    openshift_verify_ssl: "{{ (openshift_verify_ssl_config | default('false') | lower) == 'true' }}"
  when: openshift_verify_ssl_config is defined

- name: Set default verify_ssl if not set
  ansible.builtin.set_fact:
    openshift_verify_ssl: false
  when: openshift_verify_ssl is not defined


- name: Fail if config file doesn't exist
  ansible.builtin.fail:
    msg: "Config file ~/.omniaap not found. This file is required for ocaas-cluster-creds. Please create it with api_endpoint and bearer_token values."
  when: omniaap_config_raw.failed == true

- name: Fail if API endpoint is missing
  ansible.builtin.fail:
    msg: "Missing api_endpoint in ~/.omniaap. Required format: api_endpoint=https://api.example.com:6443"
  when: openshift_api_endpoint is not defined or openshift_api_endpoint == ""

- name: Fail if bearer token is missing
  ansible.builtin.fail:
    msg: "Missing bearer_token in ~/.omniaap. Required format: bearer_token=your-token-here"
  when: openshift_bearer_token is not defined or openshift_bearer_token == ""

- name: Get all credentials
  ansible.builtin.uri:
    url: "https://{{ aap_hostname }}/api/controller/v2/credentials/"
    method: GET
    user: "{{ aap_username }}"
    password: "{{ aap_password }}"
    validate_certs: "{{ aap_validate_certs }}"
    force_basic_auth: true
  register: all_credentials

- name: Check if credential exists
  ansible.builtin.set_fact:
    existing_credential: "{{ all_credentials.json.results | default([]) | selectattr('name', 'equalto', 'ocaas-cluster-creds') | list | first | default({}) }}"

- name: Get credential types
  ansible.builtin.uri:
    url: "https://{{ aap_hostname }}/api/controller/v2/credential_types/"
    method: GET
    user: "{{ aap_username }}"
    password: "{{ aap_password }}"
    validate_certs: "{{ aap_validate_certs }}"
    force_basic_auth: true
  register: credential_types

- name: Find OpenShift/Kubernetes API Bearer Token credential type
  ansible.builtin.set_fact:
    openshift_credential_type_id: "{{ item.id }}"
  loop: "{{ credential_types.json.results | default([]) }}"
  when:
    - openshift_credential_type_id is not defined or openshift_credential_type_id == None
    - ("openshift" in (item.name | lower) or "kubernetes" in (item.name | lower))
    - ("bearer" in (item.name | lower) or "token" in (item.name | lower) or "api" in (item.name | lower))
  loop_control:
    label: "{{ item.name }}"

- name: Fail if credential type not found
  ansible.builtin.fail:
    msg: "Could not find OpenShift/Kubernetes API Bearer Token credential type. Available types: {{ credential_types.json.results | default([]) | map(attribute='name') | list }}"
  when: openshift_credential_type_id is not defined or openshift_credential_type_id == None

- name: Get organization ID (default organization)
  ansible.builtin.uri:
    url: "https://{{ aap_hostname }}/api/controller/v2/organizations/"
    method: GET
    user: "{{ aap_username }}"
    password: "{{ aap_password }}"
    validate_certs: "{{ aap_validate_certs }}"
    force_basic_auth: true
  register: organizations

- name: Set default organization ID
  ansible.builtin.set_fact:
    default_organization_id: "{{ organizations.json.results[0].id | default(1) }}"

- name: Create credential if it doesn't exist
  ansible.builtin.uri:
    url: "https://{{ aap_hostname }}/api/controller/v2/credentials/"
    method: POST
    user: "{{ aap_username }}"
    password: "{{ aap_password }}"
    validate_certs: "{{ aap_validate_certs }}"
    force_basic_auth: true
    body_format: json
    body:
      name: "ocaas-cluster-creds"
      description: "openshift cluster token"
      credential_type: "{{ openshift_credential_type_id }}"
      organization: "{{ default_organization_id }}"
      inputs:
        host: "{{ openshift_api_endpoint }}"
        bearer_token: "{{ openshift_bearer_token }}"
        verify_ssl: "{{ openshift_verify_ssl | default(false) }}"
    status_code: [200, 201]
  register: create_credential_result
  when: existing_credential is not defined or existing_credential == {}
  no_log: true

- name: Update credential if it exists
  ansible.builtin.uri:
    url: "https://{{ aap_hostname }}/api/controller/v2/credentials/{{ existing_credential.id }}/"
    method: PATCH
    user: "{{ aap_username }}"
    password: "{{ aap_password }}"
    validate_certs: "{{ aap_validate_certs }}"
    force_basic_auth: true
    body_format: json
    body:
      description: "openshift cluster token"
      inputs:
        host: "{{ openshift_api_endpoint }}"
        bearer_token: "{{ openshift_bearer_token }}"
        verify_ssl: "{{ openshift_verify_ssl | default(false) }}"
    status_code: [200, 201, 202, 204]
  register: update_credential_result
  when: existing_credential is defined and existing_credential != {}
  no_log: true

- name: Display credential creation/update result
  ansible.builtin.debug:
    msg: "Credential 'ocaas-cluster-creds' {{ 'created' if (existing_credential is not defined or existing_credential == {}) else 'updated' }} successfully (ID: {{ create_credential_result.json.id | default(update_credential_result.json.id | default(existing_credential.id)) }})"

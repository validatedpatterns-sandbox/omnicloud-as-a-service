---
- hosts: localhost
  gather_facts: no

  tasks:
    - name: Read helm values
      ansible.builtin.include_vars:
        file: "/pattern-home/helm-values/values.yaml"

    - name: Read vars file
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../vars.yml"

    - name: Set AAP connection variables
      no_log: true
      ansible.builtin.set_fact:
        aap_hostname: "{{ aap_hostname | default('aap-ansible-automation-platform.' + global.localClusterDomain) }}"
        aap_validate_certs: "{{ aap_validate_certs | default(false) }}"
        aap_username: "{{ aap_username | default('admin') }}"
        aap_password: "{{ aap_password | default(lookup('file', '/pattern-home/aap-admin-password/password') | default('admin')) }}"
        cloud_providers:
          - name: "Amazon"
            template_name: "OmniCloud - Amazon Template"
          - name: "Azure"
            template_name: "OmniCloud - Azure Template"
          - name: "Google"
            template_name: "OmniCloud - Google Template"

    - name: Wait for Automation Controller to be ready
      ansible.builtin.uri:
        url: "https://{{ aap_hostname }}/api/controller/v2/ping/"
        method: GET
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        validate_certs: "{{ aap_validate_certs }}"
        force_basic_auth: true
      register: ping_check
      until: ping_check.status == 200
      retries: 30
      delay: 10
      ignore_errors: true

    - name: Create or update OpenShift cluster credential
      ansible.builtin.include_tasks: tasks/create-cluster-credential.yml
      when: openshift_create_credential | default(true)

    - name: Build survey spec from vars.yml
      ansible.builtin.set_fact:
        survey_questions:
          - question_name: "Cluster Name"
            question_description: "Name of the cluster to deploy"
            variable: "cluster_name_input"
            required: true
            type: "text"
            default: ""
          - question_name: "Cluster Group"
            question_description: "Cluster group for application deployment"
            variable: "cluster_clusterGroup_input"
            required: true
            type: "text"
            default: "devops"
          - question_name: "Base Domain"
            question_description: "Base domain for the cluster"
            variable: "cluster_baseDomain_input"
            required: true
            type: "text"
            default: ""
          - question_name: "Cloud Provider"
            question_description: "Cloud provider (aws, azure, gcp)"
            variable: "cloud_provider_input"
            required: true
            type: "multiplechoice"
            choices:
              - "Amazon"
              - "Azure"
              - "Google"
            default: ""
          - question_name: "Cloud Region"
            question_description: "Region for cloud deployment"
            variable: "cloud_region_input"
            required: true
            type: "text"
            default: ""
          - question_name: "Control Plane Replicas"
            question_description: "Number of control plane replicas"
            variable: "mp_controlPlane_replicas_input"
            required: true
            type: "integer"
            default: 3
          - question_name: "Control Plane Machine Type"
            question_description: "Machine type for control plane nodes"
            variable: "mp_controlPlane_machineType_input"
            required: true
            type: "text"
            default: ""
          - question_name: "Worker Replicas"
            question_description: "Number of worker replicas"
            variable: "mp_workers_replicas_input"
            required: true
            type: "integer"
            default: 3
          - question_name: "Worker Machine Type"
            question_description: "Machine type for worker nodes"
            variable: "mp_workers_machineType_input"
            required: true
            type: "text"
            default: ""
          - question_name: "Azure Resource Group"
            question_description: "Azure resource group name (required for Azure)"
            variable: "cc_azure_resourceGroup_input"
            required: false
            type: "text"
            default: ""
          - question_name: "GCP Project ID"
            question_description: "GCP project ID (required for GCP)"
            variable: "cc_gcp_projectID_input"
            required: false
            type: "text"
            default: ""

    - name: Build survey spec with description
      ansible.builtin.set_fact:
        survey_spec:
          name: "Cluster Deployment Survey"
          description: "Cluster deployment configuration survey"
          spec: "{{ survey_questions }}"

    - name: Get all inventories
      ansible.builtin.uri:
        url: "https://{{ aap_hostname }}/api/controller/v2/inventories/"
        method: GET
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        validate_certs: "{{ aap_validate_certs }}"
        force_basic_auth: true
      register: all_inventories

    - name: Get all projects
      ansible.builtin.uri:
        url: "https://{{ aap_hostname }}/api/controller/v2/projects/"
        method: GET
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        validate_certs: "{{ aap_validate_certs }}"
        force_basic_auth: true
      register: all_projects

    - name: Set inventory and project IDs
      ansible.builtin.set_fact:
        target_inventory_id: "{{ all_inventories.json.results | default([]) | selectattr('name', 'equalto', 'base-inventory') | list | first | default({}) | map(attribute='id') | list | first | default(all_inventories.json.results[0].id | default(1)) }}"
        target_project_id: "{{ all_projects.json.results | default([]) | selectattr('name', 'equalto', 'ocaas-project') | list | first | default({}) | map(attribute='id') | list | first | default(all_projects.json.results[0].id | default(6)) }}"

    - name: Get all credentials
      ansible.builtin.uri:
        url: "https://{{ aap_hostname }}/api/controller/v2/credentials/"
        method: GET
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        validate_certs: "{{ aap_validate_certs }}"
        force_basic_auth: true
      register: all_credentials

    - name: Set credential ID for ocaas-cluster-creds
      ansible.builtin.set_fact:
        target_credential_id: "{{ all_credentials.json.results | default([]) | selectattr('name', 'equalto', 'ocaas-cluster-creds') | list | first | default({}) | map(attribute='id') | list | first | default(None) }}"

    - name: Get all job templates
      ansible.builtin.uri:
        url: "https://{{ aap_hostname }}/api/controller/v2/job_templates/"
        method: GET
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        validate_certs: "{{ aap_validate_certs }}"
        force_basic_auth: true
      register: all_job_templates

    - name: Display available resources
      ansible.builtin.debug:
        msg: "Available inventories: {{ all_inventories.json.results | default([]) | map(attribute='name') | list }}, Available projects: {{ all_projects.json.results | default([]) | map(attribute='name') | list }}, Target inventory ID: {{ target_inventory_id }}, Target project ID: {{ target_project_id }}, Target credential ID: {{ target_credential_id }}"

    - name: Create or update job templates for each cloud provider
      ansible.builtin.include_tasks: tasks/create-job-template-survey.yml
      loop: "{{ cloud_providers }}"
      loop_control:
        label: "{{ item.template_name }}"

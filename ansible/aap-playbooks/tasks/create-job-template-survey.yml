---
- name: Check if job template exists
  ansible.builtin.set_fact:
    existing_template: "{{ all_job_templates.json.results | default([]) | selectattr('name', 'equalto', item.template_name) | list | first | default({}) }}"

- name: Create job template if it doesn't exist
  ansible.builtin.uri:
    url: "https://{{ aap_hostname }}/api/controller/v2/job_templates/"
    method: POST
    user: "{{ aap_username }}"
    password: "{{ aap_password }}"
    validate_certs: "{{ aap_validate_certs }}"
    force_basic_auth: true
    body_format: json
    body:
      name: "{{ item.template_name }}"
      description: "Job template for {{ item.name }} cloud provider deployments"
      inventory: "{{ target_inventory_id }}"
      project: "{{ target_project_id }}"
      playbook: "ansible/site.yaml"
      job_type: "run"
      credentials: "{{ [target_credential_id] if (target_credential_id is defined and target_credential_id != None) else [] }}"
    status_code: [200, 201]
  register: create_template_result
  when: existing_template is not defined or existing_template == {}
  ignore_errors: true

- name: Get job template ID (use existing or newly created)
  ansible.builtin.set_fact:
    template_id: "{{ existing_template.id if (existing_template is defined and existing_template != {}) else (create_template_result.json.id | default(None)) }}"

- name: Fail if template ID cannot be determined
  ansible.builtin.fail:
    msg: "Could not determine template ID for '{{ item.template_name }}'. Template may not exist and creation may have failed."
  when: template_id is not defined or template_id == None

- name: Display template update information
  ansible.builtin.debug:
    msg: "Updating job template '{{ item.template_name }}' (ID: {{ template_id }}) with inventory={{ target_inventory_id }}, project={{ target_project_id }}, playbook=ansible/site.yaml, credentials={{ [target_credential_id] if (target_credential_id is defined and target_credential_id != None) else [] }}"

- name: Update job template with correct inventory, project, playbook, and credentials
  ansible.builtin.uri:
    url: "https://{{ aap_hostname }}/api/controller/v2/job_templates/{{ template_id }}/"
    method: PATCH
    user: "{{ aap_username }}"
    password: "{{ aap_password }}"
    validate_certs: "{{ aap_validate_certs }}"
    force_basic_auth: true
    body_format: json
    body:
      inventory: "{{ target_inventory_id }}"
      project: "{{ target_project_id }}"
      playbook: "ansible/site.yaml"
      credentials: "{{ [target_credential_id] if (target_credential_id is defined and target_credential_id != None) else [] }}"
    status_code: [200, 201, 202, 204]
  register: update_template_result

- name: Enable survey on job template
  ansible.builtin.uri:
    url: "https://{{ aap_hostname }}/api/controller/v2/job_templates/{{ template_id }}/"
    method: PATCH
    user: "{{ aap_username }}"
    password: "{{ aap_password }}"
    validate_certs: "{{ aap_validate_certs }}"
    force_basic_auth: true
    body_format: json
    body:
      survey_enabled: true
    status_code: [200, 201, 202, 204]
  register: enable_survey_result

- name: Set survey spec on job template
  ansible.builtin.uri:
    url: "https://{{ aap_hostname }}/api/controller/v2/job_templates/{{ template_id }}/survey_spec/"
    method: POST
    user: "{{ aap_username }}"
    password: "{{ aap_password }}"
    validate_certs: "{{ aap_validate_certs }}"
    force_basic_auth: true
    body_format: json
    body: "{{ survey_spec }}"
  register: survey_result
  ignore_errors: true
  failed_when: false

- name: Check if survey spec API call failed
  ansible.builtin.fail:
    msg: "Failed to set survey spec for '{{ item.template_name }}'. Status: {{ survey_result.status | default('unknown') }}, Response: {{ survey_result.json | default(survey_result.msg) | to_nice_json }}"
  when: survey_result.status is defined and survey_result.status not in [200, 201, 202, 204]

- name: Verify survey was created
  ansible.builtin.uri:
    url: "https://{{ aap_hostname }}/api/controller/v2/job_templates/{{ template_id }}/"
    method: GET
    user: "{{ aap_username }}"
    password: "{{ aap_password }}"
    validate_certs: "{{ aap_validate_certs }}"
    force_basic_auth: true
  register: verify_template

- name: Display survey creation result
  ansible.builtin.debug:
    msg: "Job template '{{ item.template_name }}' (ID: {{ template_id }}) updated successfully. Inventory: {{ verify_template.json.inventory | default('not set') }}, Project: {{ verify_template.json.project | default('not set') }}, Playbook: {{ verify_template.json.playbook | default('not set') }}, Credentials: {{ verify_template.json.summary_fields.credentials | default([]) | map(attribute='name') | list | default(['not set']) }}, Survey enabled: {{ verify_template.json.survey_enabled | default('not set') }}"

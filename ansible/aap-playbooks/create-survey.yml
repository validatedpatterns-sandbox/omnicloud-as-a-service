---
- hosts: localhost
  gather_facts: no

  tasks:
    - name: Read helm values
      ansible.builtin.include_vars:
        file: "/pattern-home/helm-values/values.yaml"

    - name: Read vars file
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../vars.yml"

    - name: Set AAP connection variables
      no_log: true
      ansible.builtin.set_fact:
        aap_hostname: "{{ aap_hostname | default('aap-ansible-automation-platform.' + global.localClusterDomain) }}"
        aap_validate_certs: "{{ aap_validate_certs | default(false) }}"
        aap_username: "{{ aap_username | default('admin') }}"
        aap_password: "{{ aap_password | default(lookup('file', '/pattern-home/aap-admin-password/password') | default('admin')) }}"
        job_template_name: "{{ job_template_name | default('ocaas-job') }}"

    - name: Wait for Automation Controller to be ready
      ansible.builtin.uri:
        url: "https://{{ aap_hostname }}/api/controller/v2/ping/"
        method: GET
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        validate_certs: "{{ aap_validate_certs }}"
        force_basic_auth: true
      register: ping_check
      until: ping_check.status == 200
      retries: 30
      delay: 10
      ignore_errors: true

    - name: Build survey spec from vars.yml
      ansible.builtin.set_fact:
        survey_spec:
          - question_name: "Cluster Name"
            question_description: "Name of the cluster to deploy"
            variable: "cluster_name_input"
            required: true
            type: "text"
            default: ""
          - question_name: "Cluster Group"
            question_description: "Cluster group for application deployment"
            variable: "cluster_clusterGroup_input"
            required: true
            type: "text"
            default: ""
          - question_name: "Base Domain"
            question_description: "Base domain for the cluster"
            variable: "cluster_baseDomain_input"
            required: true
            type: "text"
            default: ""
          - question_name: "Cloud Provider"
            question_description: "Cloud provider (aws, azure, gcp)"
            variable: "cloud_provider_input"
            required: true
            type: "multiplechoice"
            choices:
              - "aws"
              - "azure"
              - "gcp"
            default: ""
          - question_name: "Cloud Region"
            question_description: "Region for cloud deployment"
            variable: "cloud_region_input"
            required: true
            type: "text"
            default: ""
          - question_name: "Control Plane Replicas"
            question_description: "Number of control plane replicas"
            variable: "mp_controlPlane_replicas_input"
            required: true
            type: "integer"
            default: "3"
          - question_name: "Control Plane Machine Type"
            question_description: "Machine type for control plane nodes"
            variable: "mp_controlPlane_machineType_input"
            required: true
            type: "text"
            default: ""
          - question_name: "Worker Replicas"
            question_description: "Number of worker replicas"
            variable: "mp_workers_replicas_input"
            required: true
            type: "integer"
            default: "3"
          - question_name: "Worker Machine Type"
            question_description: "Machine type for worker nodes"
            variable: "mp_workers_machineType_input"
            required: true
            type: "text"
            default: ""
          - question_name: "Azure Resource Group"
            question_description: "Azure resource group name (required for Azure)"
            variable: "cc_azure_resourceGroup_input"
            required: false
            type: "text"
            default: ""
          - question_name: "GCP Project ID"
            question_description: "GCP project ID (required for GCP)"
            variable: "cc_gcp_projectID_input"
            required: false
            type: "text"
            default: ""

    - name: Get all job templates
      ansible.builtin.uri:
        url: "https://{{ aap_hostname }}/api/controller/v2/job_templates/"
        method: GET
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        validate_certs: "{{ aap_validate_certs }}"
        force_basic_auth: true
      register: all_job_templates

    - name: Find job template by name
      ansible.builtin.set_fact:
        matching_templates: "{{ all_job_templates.json.results | default([]) | selectattr('name', 'equalto', job_template_name) | list }}"

    - name: Set job template to use (use specified name or fallback to first available)
      ansible.builtin.set_fact:
        job_template_exists: "{{ matching_templates | length > 0 }}"
        job_template_to_use: "{{ matching_templates[0] if matching_templates | length > 0 else (all_job_templates.json.results | default([]) | first) }}"
        actual_template_name: "{{ (matching_templates[0].name if matching_templates | length > 0 else (all_job_templates.json.results | default([]) | first).name) | default(job_template_name) }}"

    - name: Set job template ID
      ansible.builtin.set_fact:
        job_template_id: "{{ job_template_to_use.id }}"
      when: job_template_to_use is defined

    - name: Display template selection
      ansible.builtin.debug:
        msg: "Using job template: '{{ actual_template_name }}' (ID: {{ job_template_id }}){% if not job_template_exists %}. Note: Requested template '{{ job_template_name }}' not found, using first available template.{% endif %}"

    - name: Display all available job templates
      ansible.builtin.debug:
        msg: "Available job templates: {{ all_job_templates.json.results | default([]) | map(attribute='name') | list }}"

    - name: Fail if no job templates available
      ansible.builtin.fail:
        msg: "No job templates found in AAP. Cannot create survey."
      when: all_job_templates.json.results | default([]) | length == 0

    - name: Enable survey on job template
      ansible.builtin.uri:
        url: "https://{{ aap_hostname }}/api/controller/v2/job_templates/{{ job_template_id }}/"
        method: PATCH
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        validate_certs: "{{ aap_validate_certs }}"
        force_basic_auth: true
        body_format: json
        body:
          survey_enabled: true
      register: enable_survey_result
      when: job_template_id is defined

    - name: Debug survey spec before sending
      ansible.builtin.debug:
        var: survey_spec

    - name: Set survey spec on job template
      ansible.builtin.uri:
        url: "https://{{ aap_hostname }}/api/controller/v2/job_templates/{{ job_template_id }}/survey_spec/"
        method: POST
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        validate_certs: "{{ aap_validate_certs }}"
        force_basic_auth: true
        body_format: json
        body: "{{ survey_spec }}"
      register: job_template_result
      when: job_template_id is defined
      ignore_errors: true

    - name: Debug API response
      ansible.builtin.debug:
        var: job_template_result
      when: job_template_result is defined

    - name: Debug survey spec API response
      ansible.builtin.debug:
        var: job_template_result
      when: job_template_result is defined

    - name: Check if survey spec API call failed
      ansible.builtin.fail:
        msg: "Failed to set survey spec. Status: {{ job_template_result.status | default('unknown') }}, Response: {{ job_template_result.json | default(job_template_result.msg) | to_nice_json }}"
      when: job_template_result is defined and job_template_result.status not in [200, 201, 202, 204]

    - name: Get survey spec to verify
      ansible.builtin.uri:
        url: "https://{{ aap_hostname }}/api/controller/v2/job_templates/{{ job_template_id }}/survey_spec/"
        method: GET
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        validate_certs: "{{ aap_validate_certs }}"
        force_basic_auth: true
      register: verify_survey_spec
      when: job_template_result is defined and job_template_result.status in [200, 201, 202, 204]

    - name: Verify survey was created
      ansible.builtin.uri:
        url: "https://{{ aap_hostname }}/api/controller/v2/job_templates/{{ job_template_id }}/"
        method: GET
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        validate_certs: "{{ aap_validate_certs }}"
        force_basic_auth: true
      register: verify_template
      when: job_template_result is defined and job_template_result.status in [200, 201, 202, 204]

    - name: Display survey verification
      ansible.builtin.debug:
        msg: "Survey enabled: {{ verify_template.json.survey_enabled | default('not set') }}, Survey spec count: {{ verify_survey_spec.json | default([]) | length }}"
      when: verify_template is defined and verify_survey_spec is defined

    - name: Display survey creation result
      ansible.builtin.debug:
        msg: "Survey created/updated successfully for job template '{{ actual_template_name }}' (ID: {{ job_template_id }})"
      when: job_template_result is defined and job_template_result.status in [200, 201, 202, 204]

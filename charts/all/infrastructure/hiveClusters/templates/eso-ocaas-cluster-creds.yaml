---
# ExternalSecret that creates the ocaas-cluster-creds secret for AAP
# This secret contains the API endpoint, bearer token, and verify_ssl flag
# needed for the OpenShift/Kubernetes API Bearer Token credential in AAP.
#
# The bearer_token is pulled from Vault (pushed there by eso-push-ocaas-mgr-token PushSecret).
# The api_endpoint and verify_ssl are read from the ocaas-cluster-api-endpoint ConfigMap.
# verify_ssl defaults to "false" but can be overridden by updating the ConfigMap:
#   kubectl patch configmap ocaas-cluster-api-endpoint -n hive --type merge -p '{"data":{"verify_ssl":"true"}}'
apiVersion: "external-secrets.io/v1beta1"
kind: ExternalSecret
metadata:
  name: eso-ocaas-cluster-creds
  namespace: hive
  annotations:
    argocd.argoproj.io/sync-wave: "3"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: {{ .Values.secretStore.name }}
    kind: {{ .Values.secretStore.kind }}
  target:
    name: ocaas-cluster-creds
    namespace: ansible-automation-platform
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        # Use 'host' to match AAP credential input key, but also include 'api_endpoint' for backward compatibility
        # These will be populated by External Secrets Operator from the ConfigMap and token secret
        host: '{{ if .Secret }}{{ index .Secret "api_endpoint" | default "" | b64enc }}{{ else }}{{ "" | b64enc }}{{ end }}'
        api_endpoint: '{{ if .Secret }}{{ index .Secret "api_endpoint" | default "" | b64enc }}{{ else }}{{ "" | b64enc }}{{ end }}'
        bearer_token: '{{ if .Secret }}{{ index .Secret "bearer_token" | default "" | b64enc }}{{ else }}{{ "" | b64enc }}{{ end }}'
        verify_ssl: '{{ if .Secret }}{{ index .Secret "verify_ssl" | default "false" | b64enc }}{{ else }}{{ "false" | b64enc }}{{ end }}'
  dataFrom:
  # Get api_endpoint and verify_ssl from the ConfigMap (populated by update-api-endpoint Job)
  - find:
      name:
        regexp: ocaas-cluster-api-endpoint
      type: ConfigMap
  data:
  # Get bearer_token from Vault (pushed there by eso-push-ocaas-mgr-token PushSecret)
  - secretKey: bearer_token
    remoteRef:
      key: {{ .Values.ocaasClusterCreds.key | default "secret/data/hub/ocaas-cluster-creds" }}
      property: bearer_token

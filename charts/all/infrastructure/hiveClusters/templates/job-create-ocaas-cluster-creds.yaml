---
# Job that creates the ocaas-cluster-creds secret by combining data from:
# - ocaas-mgr-token secret (for bearer_token)
# - ocaas-cluster-api-endpoint ConfigMap (for api_endpoint and verify_ssl)
# This avoids Vault permission issues since we're only reading from Kubernetes resources
apiVersion: batch/v1
kind: Job
metadata:
  name: create-ocaas-cluster-creds
  namespace: hive
  annotations:
    argocd.argoproj.io/sync-wave: "3"
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: ocaas-mgr
      restartPolicy: OnFailure
      containers:
      - name: create-secret
        image: registry.redhat.io/openshift4/ose-cli:latest
        command:
        - /bin/bash
        - -c
        - |
          set -e
          
          # Read bearer token from secret
          TOKEN=$(oc get secret ocaas-mgr-token -n hive -o jsonpath='{.data.token}' | base64 -d)
          if [ -z "$TOKEN" ]; then
            echo "Error: Could not retrieve token from ocaas-mgr-token secret"
            exit 1
          fi
          
          # Read API endpoint from ConfigMap
          API_ENDPOINT=$(oc get configmap ocaas-cluster-api-endpoint -n hive -o jsonpath='{.data.api_endpoint}')
          if [ -z "$API_ENDPOINT" ]; then
            echo "Error: Could not retrieve api_endpoint from ConfigMap"
            exit 1
          fi
          
          # Read verify_ssl from ConfigMap (default to false if not set)
          VERIFY_SSL=$(oc get configmap ocaas-cluster-api-endpoint -n hive -o jsonpath='{.data.verify_ssl}')
          VERIFY_SSL=${VERIFY_SSL:-"false"}
          
          # Create or update the secret in ansible-automation-platform namespace
          oc create secret generic ocaas-cluster-creds \
            --from-literal=host="$API_ENDPOINT" \
            --from-literal=api_endpoint="$API_ENDPOINT" \
            --from-literal=bearer_token="$TOKEN" \
            --from-literal=verify_ssl="$VERIFY_SSL" \
            -n ansible-automation-platform \
            --dry-run=client -o yaml | oc apply -f -
          
          echo "Successfully created/updated ocaas-cluster-creds secret"
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          runAsNonRoot: true
          seccompProfile:
            type: RuntimeDefault

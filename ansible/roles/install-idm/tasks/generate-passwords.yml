---
# Task to generate passwords for IDM admin and users
# This task generates secure random passwords and saves them to a file

- name: Set idm_users from idm.users if needed
  ansible.builtin.set_fact:
    idm_users: "{{ idm_users | default(idm.users | default([])) }}"

- name: Set passwords directory to ~/.ansible/passwords
  ansible.builtin.set_fact:
    passwords_output_dir: "{{ passwords_output_dir | default(lookup('env', 'HOME') + '/.ansible/passwords') }}"
  delegate_to: localhost
  become: false
  run_once: true

- name: Set password file identifier (without timestamp for idempotency)
  ansible.builtin.set_fact:
    password_file_id: "{{ ipa_zone | default(domain) | default('idm') | replace('.', '-') }}"
  run_once: true

- name: Check if password file already exists to read existing password
  ansible.builtin.stat:
    path: "{{ passwords_output_dir }}/idm-passwords-{{ password_file_id }}.txt"
  delegate_to: localhost
  become: false
  run_once: true
  register: existing_password_file_stat

- name: Extract existing admin password from password file if it exists
  ansible.builtin.shell: |
    set -o pipefail
    grep "IPA Admin Password:" "{{ passwords_output_dir }}/idm-passwords-{{ password_file_id }}.txt" 2>/dev/null | sed 's/^[^:]*: *//' | head -1 || echo ""
  delegate_to: localhost
  become: false
  run_once: true
  register: existing_admin_password
  when: existing_password_file_stat.stat.exists | default(false)
  changed_when: false
  failed_when: false
  no_log: true

- name: Use existing password from file for IDM admin/Directory Manager (idempotency)
  ansible.builtin.set_fact:
    generated_ipa_pw: "{{ existing_admin_password.stdout }}"
  when: >
    (ipa_pw is not defined or ipa_pw == "ENTER_SOME_PW" or ipa_pw == "CHANGE_ME")
    and existing_password_file_stat.stat.exists | default(false)
    and existing_admin_password.stdout | default('') != ''

- name: Generate password for IDM admin/Directory Manager (only if not using existing or provided)
  ansible.builtin.set_fact:
    generated_ipa_pw: "{{ lookup('password', '/dev/null length=20 chars=ascii_letters,digits,.,!,#,$,%,&,*,+,-,/,=,?,@,^,_,|,~') }}"
  when: >
    (ipa_pw is not defined or ipa_pw == "ENTER_SOME_PW" or ipa_pw == "CHANGE_ME")
    and not (existing_password_file_stat.stat.exists | default(false) and existing_admin_password.stdout | default('') != '')

- name: Use provided password for IDM admin/Directory Manager
  ansible.builtin.set_fact:
    generated_ipa_pw: "{{ ipa_pw }}"
  when: ipa_pw is defined and ipa_pw != "ENTER_SOME_PW" and ipa_pw != "CHANGE_ME"

- name: Initialize user passwords dictionary
  ansible.builtin.set_fact:
    generated_user_passwords: {}

- name: Generate passwords for IDM users
  ansible.builtin.set_fact:
    generated_user_passwords: >-
      {{ generated_user_passwords | combine({
        item.name: lookup('password',
        '/dev/null length=20 chars=ascii_letters,digits,.,!,#,$,%,&,*,+,-,/,=,?,@,^,_,|,~')
      }) }}
  loop: "{{ idm_users | default([]) }}"
  when: idm_users is defined and idm_users | length > 0

- name: Debug generated user passwords
  ansible.builtin.debug:
    msg:
      - "Generated user passwords: {{ generated_user_passwords }}"
      - "Number of users: {{ idm_users | default([]) | length }}"
  when: idm_users is defined and idm_users | length > 0

- name: Set final IPA passwords
  ansible.builtin.set_fact:
    final_ipa_pw: "{{ generated_ipa_pw }}"
    final_ipaadmin_password: "{{ generated_ipa_pw }}"
    final_ipadm_password: "{{ generated_ipa_pw }}"
    generated_user_passwords: "{{ generated_user_passwords | default({}) }}"
  run_once: true

- name: Ensure passwords directory exists
  ansible.builtin.file:
    path: "{{ passwords_output_dir }}"
    state: directory
    mode: '0700'
  delegate_to: localhost
  become: false
  run_once: true

- name: Create password file content for text format
  ansible.builtin.set_fact:
    password_file_text_content: |
      ============================================================================
      IDM/FreeIPA Password File
      ============================================================================
      Generated: {{ ansible_date_time.iso8601 }}
      Domain: {{ ipa_zone | default(domain) }}
      Realm: {{ ipaserver_realm | default(ipa_zone | default(domain) | upper) }}
      Server: {{ ipaserver_hostname | default('idm-server') }}

      ============================================================================
      Admin Credentials
      ============================================================================
      IPA Admin Principal: admin@{{ ipaserver_realm | default(ipa_zone | default(domain) | upper) }}
      IPA Admin Password: {{ final_ipa_pw }}
      Directory Manager Password: {{ final_ipa_pw }}

      Example kinit command:
        echo '{{ final_ipa_pw }}' | kinit admin@{{ ipaserver_realm | default(ipa_zone | default(domain) | upper) }}

      ============================================================================
      User Passwords
      ============================================================================
      {% for user in idm_users | default([]) %}
      {% if generated_user_passwords is defined and generated_user_passwords[user.name] is defined %}
      Username: {{ user.name }}
      Principal: {{ user.name }}@{{ ipaserver_realm | default(ipa_zone | default(domain) | upper) }}
      Password: {{ generated_user_passwords[user.name] }}
      Full Name: {{ user.first }} {{ user.last }}

      Example kinit command:
        echo '{{ generated_user_passwords[user.name] }}' | kinit {{ user.name }}@{{ ipaserver_realm | default(ipa_zone | default(domain) | upper) }}

      Alternative (interactive):
        kinit {{ user.name }}@{{ ipaserver_realm | default(ipa_zone | default(domain) | upper) }}

      {% endif %}
      {% endfor %}
      {% if idm_users | default([]) | length == 0 %}
      No users configured.
      {% endif %}

      ============================================================================
      USING PASSWORDS WITH KINIT
      ============================================================================
      IMPORTANT: Passwords may contain special characters that need proper handling.

      Method 1 (Recommended - Non-interactive):
        echo 'PASSWORD' | kinit USERNAME@REALM

      Method 2 (Interactive - Prompts for password):
        kinit USERNAME@REALM

      Method 3 (Using password file - More secure):
        kinit -f USERNAME@REALM < password_file.txt

      Note: Always use the full principal format: username@REALM
      The realm is: {{ ipaserver_realm | default(ipa_zone | default(domain) | upper) }}

      ============================================================================
      IMPORTANT SECURITY NOTES
      ============================================================================
      - Store this file securely
      - Delete this file after recording passwords in a secure password manager
      - Do not commit this file to version control
      - Change default passwords in production environments
      ============================================================================
  run_once: true

- name: Check if password file already exists
  ansible.builtin.stat:
    path: "{{ passwords_output_dir }}/idm-passwords-{{ password_file_id }}.txt"
  delegate_to: localhost
  become: false
  run_once: true
  register: password_file_stat

- name: Create or update password file with IDM credentials
  ansible.builtin.copy:
    dest: "{{ passwords_output_dir }}/idm-passwords-{{ password_file_id }}.txt"
    content: "{{ password_file_text_content }}"
    mode: '0600'
  delegate_to: localhost
  become: false
  run_once: true

- name: Create password file content for YAML format
  ansible.builtin.set_fact:
    password_file_yaml_content: |
      ---
      # IDM/FreeIPA Password File (YAML format)
      # Generated: {{ ansible_date_time.iso8601 }}
      # Domain: {{ ipa_zone | default(domain) }}
      # Realm: {{ ipaserver_realm | default(ipa_zone | default(domain) | upper) }}
      # Server: {{ ipaserver_hostname | default('idm-server') }}
      #
      # Usage with kinit:
      #   echo "${password}" | kinit "${principal}"
      #   Example: echo "${idm_passwords.users.reader.password}" | kinit "${idm_passwords.users.reader.principal}"

      idm_passwords:
        realm: "{{ ipaserver_realm | default(ipa_zone | default(domain) | upper) }}"
        domain: "{{ ipa_zone | default(domain) }}"
        admin:
          principal: "admin@{{ ipaserver_realm | default(ipa_zone | default(domain) | upper) }}"
          ipa_admin_password: "{{ final_ipa_pw }}"
          directory_manager_password: "{{ final_ipa_pw }}"
        users:
          {% for user in idm_users | default([]) %}
          {% if generated_user_passwords is defined and generated_user_passwords[user.name] is defined %}
          {{ user.name }}:
            username: "{{ user.name }}"
            principal: "{{ user.name }}@{{ ipaserver_realm | default(ipa_zone | default(domain) | upper) }}"
            password: "{{ generated_user_passwords[user.name] }}"
            first_name: "{{ user.first }}"
            last_name: "{{ user.last }}"
          {% endif %}
          {% endfor %}
  run_once: true

- name: Check if YAML password file already exists
  ansible.builtin.stat:
    path: "{{ passwords_output_dir }}/idm-passwords-{{ password_file_id }}.yml"
  delegate_to: localhost
  become: false
  run_once: true
  register: password_file_yaml_stat

- name: Create or update password file (YAML format) for programmatic access
  ansible.builtin.copy:
    dest: "{{ passwords_output_dir }}/idm-passwords-{{ password_file_id }}.yml"
    content: "{{ password_file_yaml_content }}"
    mode: '0600'
  delegate_to: localhost
  become: false
  run_once: true

- name: Display password file location
  ansible.builtin.debug:
    msg:
      - "Password files:"
      - "  Text: {{ passwords_output_dir }}/idm-passwords-{{ password_file_id }}.txt"
      - "  YAML: {{ passwords_output_dir }}/idm-passwords-{{ password_file_id }}.yml"
      - "  Status: {{ 'Updated' if (password_file_stat.stat.exists | default(false) or password_file_yaml_stat.stat.exists | default(false)) else 'Created' }}"
      - ""
      - "IMPORTANT: Store these passwords securely and delete the files after recording them!"
      - ""
      - "NOTE: These passwords match what will be used/used during IDM installation."
      - "If passwords don't work, verify the installation used these same passwords."
  delegate_to: localhost
  become: false
  run_once: true
